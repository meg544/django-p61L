{% extends 'base.html' %}
{% load formatos %}
{% block content %}

<div class="container mt-4">
  <div class="sticky-top-buttons">
    <h3>Listado de Gastos (Modificar solo estatus)</h3>
    <h6>Evento: {{ evento.nombre }}</h6>
    <!-- CORREGIDO: Elimino el </strong> anidado incorrectamente -->
    <p><strong>Total:</strong> {{ total|formato_pesos }}</p>

    <div class="row mb-2">
      <div class="col-md-4">
        <label><strong>Filtrar por proveedor:</strong></label>
        <select id="filtroProveedor" class="form-select" onchange="filtrarProveedor()">
          <option value="">-- Todos --</option>

          {% for proveedor_id, proveedor_nombre in proveedores %}
          <option value="{{ proveedor_nombre|lower }}">{{ proveedor_nombre }}</option>
          {% endfor %}
        </select>
      </div>
    </div>
  </div>

  <table class="table table-bordered mt-3" id="tablaGastos">
    <thead>
    <tr>
      <th>Folio</th>
      <th>Fecha</th>
      <th>Importe</th>
      <th>Tipo Movimiento</th>
      <th>Proveedor</th>
      <th>Comentarios</th>
      <!-- AÑADIDO: Columna para el estatus visual -->
      <th>Estatus</th>
    </tr>
    </thead>

    <tbody>
    {% for gasto in gastos %}
    <tr id="fila-{{ gasto.folio }}">
      <td>{{ gasto.folio }}</td>
      <td>{{ gasto.fecha|date:"d/m/Y" }}</td>
      <td>{{ gasto.importe|formato_pesos }}</td>
      <td>{{ gasto.concepto }}</td>
      <td class="col-proveedor">{{ gasto.proveedor.nombre }}</td>
      <td class="comentarios-col">{{ gasto.comentarios }}</td>

      <td>
        <!-- SELECT PARA CAMBIAR ESTATUS -->
        <!-- NOTA: El valor del select ya refleja el estatus actual debido al 'selected' de Django. -->
        <select class="form-select form-select-sm"
                onchange="actualizarEstatus({{ gasto.folio }}, this.value)">
          <option value="ok" {% if gasto.estatus == 'ok' %}selected{% endif %}>✔️</option>
          <option value="not_ok" {% if gasto.estatus == 'not_ok' %}selected{% endif %}>❌</option>
        </select>

        <!-- Ícono dinámico que se actualiza con JS -->
        <div id="icono-{{ gasto.folio }}" class="mt-1">
          {% if gasto.estatus == "ok" %}
          ✔️
          {% else %}
          ❌
          {% endif %}
        </div>
      </td>

    </tr>
    {% endfor %}
    </tbody>
  </table>
</div>


<script>
/* ======================================================
   ACTUALIZAR ESTATUS CON SELECT (AJAX)
====================================================== */
function actualizarEstatus(folio, nuevoEstatus){

    // CORREGIDO: La URL de fetch debe coincidir con el endpoint de tu vista.
    // Asumo que tu URL para cambiar estatus espera el folio como parámetro de URL
    // y lee el nuevo estatus del cuerpo JSON.
    fetch(`/estatus/cambiar/${folio}/`, {
        method: "POST",
        headers: {
            "X-CSRFToken": "{{ csrf_token }}",
            "Content-Type": "application/json"
        },
        body: JSON.stringify({ estatus: nuevoEstatus })
    })
    .then(res => res.json())
    .then(data => {
        // Asumo que 'data.icono' devuelve el string "✔️" o "❌"
        let icono = document.getElementById("icono-" + folio);
        icono.innerHTML = data.icono;
    })
    .catch(error => {
        console.error('Error actualizando el estatus:', error);
        alert('Hubo un error al actualizar el estatus.');
    });
}


/* ======================================================
   FILTRO PROVEEDOR
====================================================== */
function filtrarProveedor() {
    let filtro = document.getElementById("filtroProveedor").value.toLowerCase();
    let filas = document.querySelectorAll("#tablaGastos tbody tr");

    filas.forEach(fila => {
        let proveedor = fila.querySelector(".col-proveedor").innerText.toLowerCase();

        fila.style.display = (filtro === "" || proveedor === filtro) ? "" : "none";
    });
}
</script>

{% endblock %}
